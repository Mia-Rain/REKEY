<body>
</body>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
var urlParams = new URLSearchParams(window.location.search);
console.log(urlParams.get('code'));
var code = urlParams.get('code');
const CLID = sessionStorage.getItem('CLID');
const CLSEC = sessionStorage.getItem('CLSEC');
function millisToMinutesAndSeconds(millis) {
  var minutes = Math.floor(millis / 60000);
  var seconds = ((millis % 60000) / 1000).toFixed(0);
  return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
}
$.ajax({
            type: 'POST',
            url: "https://accounts.spotify.com/api/token",
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            contentType: 'application/x-www-form-urlencoded; charset=utf-8',
            dataType: 'json',
            data: { 'client_id': CLID, 'client_secret': CLSEC, 'redirect_uri': 'https://www.thatgeekyweeb.is-dummy-thi.cc/REKEY/callback/', code, 'grant_type': "authorization_code" },
            success: function (response, data) {
                	console.log(response);
			console.log(data);
                	sessionStorage.setItem('refresh_token', response.refresh_token);
	    },
	    error: function () {
		    window.location.replace('https://www.thatgeekyweeb.is-dummy-thi.cc/REKEY');
	    }
});
window.refresh_token = sessionStorage.getItem('refresh_token');
function auth(){
	$.ajax({
  	      type: 'POST',
    	      url: 'https://accounts.spotify.com/api/token',
      	      contentType: 'application/x-www-form-urlencoded',
              data: { 'client_id': sessionStorage.getItem('CLID'), 'client_secret': sessionStorage.getItem('CLSEC'), 'grant_type': 'refresh_token', 'refresh_token': window.refresh_token },
      	      success: function (response, data) {
			    sessionStorage.setItem('access_token', response.access_token);
    	      },
              error: function (xhr, ajaxOptions, thrownError) {
                location.reload();
              }
	});
	window.access_token = sessionStorage.getItem('access_token');
}
auth();
window.history.replaceState(null, null, window.location.pathname); // Emptys the URL params since there ugly
document.body.innerText= 'REKEY=' + sessionStorage.getItem('refresh_token');
</script>
